version: '3.8'

# docker-compose for local development:
# - app: PHP container (builds from Dockerfile). Runs "php artisan serve" on :8000 by default.
# - vite: Node container to run Vite dev server (binds to 0.0.0.0 so host/container can access).
# Shared volume mounts project directory into both containers.

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      # You can specify build args for production here
    image: paintful-life-app:dev
    container_name: paintful_app
    env_file:
      - .env # you can keep local .env with overrides if desired (recommended)
    environment:
      # Minimal Laravel env defaults; override in .env as needed
      APP_ENV: local
      APP_DEBUG: 'true'
      APP_KEY: base64:SomeTempKeyReplace
      # SQLite DB path inside the container (shared with host via volume)
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/html/database/database.sqlite
      # Vite related env (front-end) -- used by Vite client if necessary
      VITE_DEV_SERVER: 'http://vite:5173'
    volumes:
      - ./:/var/www/html:cached
    ports:
      - "8000:8000"  # maps container's artisan serve to host:8000
    depends_on:
      - vite
    # For Windows WSL users, you may need to set extra_hosts or adjust mounts
    tty: true

  vite:
    image: node:20
    container_name: paintful_vite
    working_dir: /var/www/html
    command: sh -c "npm ci --silent && npm run dev -- --host 0.0.0.0"
    environment:
      # Force Vite to bind to all interfaces; also helpful for HMR across containers
      # If your Vite config uses env variables (VITE_*), set them here.
      # You can also add CHOKIDAR_USEPOLLING for Windows host file watching if needed.
      CHOKIDAR_USEPOLLING: 'true'
      # Some setups need to set HOST explicitly:
      HOST: 0.0.0.0
    volumes:
      - ./:/var/www/html:cached
    ports:
      - "5173:5173"   # Vite dev server
    stdin_open: true
    tty: true

# Notes / instructions:
#
# - Use `docker-compose up --build` to build images and start both services.
# - For dev, open:
#     http://localhost:8000    -> Laravel app (artisan serve)
#     http://localhost:5173    -> Vite dev server (if you need to access raw Vite)
#
# - Make sure your Laravel `config/vite.php` or your blade templates reference Vite correctly
#   and that Vite uses the correct host for HMR. Example in blade:
#     @if (app()->environment('local'))\n
#       <script type=\"module\" src=\"http://localhost:5173/@vite/client\"></script>\n
#     @endif
#
# - Ensure you have `database/database.sqlite` present or it will be created by the Dockerfile.
#   If you keep SQLite file on host, it will persist across container restarts (volume mount).
#
# - For production you should:
#   - Build assets with `npm run build` (either using node-build stage or local node).
#   - Use a proper webserver (nginx) with php-fpm instead of artisan serve.
#
# - If you prefer to build assets in the Docker build (multi-stage), uncomment/use the node-build stage in the Dockerfile
#   and modify the Dockerfile final stage to copy dist/public assets into the php image.
#
# Example local dev workflow:
#   1) Copy .env.example to .env (set APP_KEY, etc). Ensure DB_CONNECTION=sqlite and DB_DATABASE=/var/www/html/database/database.sqlite
#   2) docker-compose up --build
#   3) In a shell (or let Dockerfile run migrations): docker-compose exec app php artisan migrate
#   4) Visit http://localhost:8000